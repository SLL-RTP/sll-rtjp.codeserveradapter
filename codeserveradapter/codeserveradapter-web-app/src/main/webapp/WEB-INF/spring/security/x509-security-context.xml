<?xml version="1.0" encoding="UTF-8" ?>
<!--

    Copyright (c) 2013 SLL. <http://sll.se>

    This file is part of Invoice-Data.

        Invoice-Data is free software: you can redistribute it and/or modify
        it under the terms of the GNU Lesser General Public License as published by
        the Free Software Foundation, either version 3 of the License, or
        (at your option) any later version.

        Invoice-Data is distributed in the hope that it will be useful,
        but WITHOUT ANY WARRANTY; without even the implied warranty of
        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        GNU Lesser General Public License for more details.

        You should have received a copy of the GNU Lesser General Public License
        along with Invoice-Data.  If not, see <http://www.gnu.org/licenses/lgpl.txt>.

-->

<beans xmlns="http://www.springframework.org/schema/beans" 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:sec="http://www.springframework.org/schema/security"
    xmlns:util="http://www.springframework.org/schema/util"
    xsi:schemaLocation="http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.1.xsd
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.0.xsd">
  
  <sec:http create-session="never" authentication-manager-ref="preAuthenticationManager" entry-point-ref="http403EntryPoint" >
    <sec:intercept-url pattern="/ws/cancelForm" access="ROLE_ADMIN" requires-channel="https"/>
    <sec:intercept-url pattern="/ws/createForm" access="ROLE_ADMIN" requires-channel="https"/>
    <sec:intercept-url pattern="/ws/createFormRequest" access="ROLE_ADMIN" requires-channel="https"/>
    <sec:intercept-url pattern="/ws/getForm" access="ROLE_ADMIN" requires-channel="https"/>
    <sec:intercept-url pattern="/ws/getFormQuestionPage" access="ROLE_ADMIN" requires-channel="https"/>
    <sec:intercept-url pattern="/ws/getForms" access="ROLE_ADMIN" requires-channel="https"/>
    <sec:intercept-url pattern="/ws/getFormTemplates" access="ROLE_ADMIN" requires-channel="https"/>
    <sec:intercept-url pattern="/ws/saveFormPage" access="ROLE_USER" requires-channel="https"/>
    <sec:intercept-url pattern="/ws/saveForm" access="ROLE_USER" requires-channel="https"/>
    <sec:anonymous enabled="false" />
    <sec:custom-filter ref="x509AuthFilter" position="X509_FILTER"/>
  </sec:http>

  <bean id="http403EntryPoint" class="org.springframework.security.web.authentication.Http403ForbiddenEntryPoint"/>

  <bean id="x509AuthFilter" class="org.springframework.security.web.authentication.preauth.x509.X509AuthenticationFilter">
    <property name="authenticationManager" ref="preAuthenticationManager"/>
    <property name="continueFilterChainOnUnsuccessfulAuthentication" value="false"/>
    <property name="principalExtractor" ref="principalExtractor"/>
  </bean>
  
  <bean id="principalExtractor" class="org.springframework.security.web.authentication.preauth.x509.SubjectDnX509PrincipalExtractor">
    <property name="subjectDnRegex" value="CN=(.*?),"/>
  </bean>
  
  <authentication-manager alias="preAuthenticationManager" xmlns="http://www.springframework.org/schema/security">
      <authentication-provider ref="preauthAuthProvider"/>
  </authentication-manager>
  
  <bean id="preauthAuthProvider" class="org.springframework.security.web.authentication.preauth.PreAuthenticatedAuthenticationProvider">
      <property name="preAuthenticatedUserDetailsService" ref="preAuthenticatedUserDetails"/>
  </bean>
  
  <bean id="preAuthenticatedUserDetails" class="se.eservicesupply.formengine.admin.security.TestAuthenticationUserDetailsService"/>
  
</beans>
    